# Stage 2 Topic Limit Implementation

## Overview

Implemented dynamic topic limit support for **Stage 2 (Topic Generation)** to make it consistent with other workflow stages (Stage 3, 4, 6). Previously, Stage 2 always generated exactly 50 topics regardless of the `--topic-limit` parameter.

## Problem Statement

**Before the fix:**
```bash
$ node main.js stage topics --topic-limit=1

ğŸ“Š Target: 50 strategic topics  # âŒ Ignores limit
âœ… Generated 50 topics            # âŒ Always generates 50
```

The system would:
- âœ… Parse `--topic-limit=1` correctly from CLI
- âœ… Store it in config
- âŒ **Ignore it completely in Stage 2**
- âŒ Always generate 50 topics (hardcoded)

## Root Cause

### 1. Hardcoded Values in `topic-generator.js`

**Lines 250-251** (before fix):
```javascript
async generateTopicsInBatches(approvedGaps) {
  const targetTotal = 50;      // âŒ Hardcoded
  const batchSize = 25;         // âŒ Hardcoded
  const batches = Math.ceil(targetTotal / batchSize);
```

### 2. No topicLimit Property in Constructor

**Lines 35-37** (before fix):
```javascript
constructor(config = {}) {
  // ...
  this.selectedCategory = config.category || null;
  // âŒ NO this.topicLimit property
}
```

### 3. Orchestrator Not Passing Limit

**Line 271** in `workflow-orchestrator.js` (before fix):
```javascript
// Generate topics - NO parameters passed
const topics = await this.topicGenerator.generateTopics();  // âŒ
```

## Implementation

### 1. Add topicLimit Property to TopicGenerator

**`topic-generator.js:39-40`**
```javascript
constructor(config = {}) {
  // ...
  this.selectedCategory = config.category || null;

  // ğŸ¯ Topic limit for controlled generation
  this.topicLimit = config.topicLimit || null;  // âœ… NEW

  // ...
}
```

### 2. Add Debug Logging

**`topic-generator.js:80-82`**
```javascript
validateConfig() {
  // ...
  if (this.selectedCategory) {
    console.log(`ğŸ“‚ Category Focus: ${this.selectedCategory.toUpperCase()}`);
  }
  if (this.topicLimit !== null) {
    console.log(`ğŸ“Š Topic Limit: ${this.topicLimit}`);  // âœ… NEW
  }
  return true;
}
```

### 3. Use Dynamic Target in generateTopics()

**`topic-generator.js:124-137`**
```javascript
async generateTopics() {
  // âœ… NEW: Determine effective topic target
  const targetTopics = this.topicLimit ?? 50;

  console.log('\nğŸ¯ TOPIC GENERATION STARTED');
  console.log('='.repeat(50));
  console.log(`ğŸ¤– AI Model: ${this.groqModel}`);
  console.log(`ğŸ“Š Target: ${targetTopics} strategic topics`);  // âœ… Dynamic

  if (this.selectedCategory) {
    console.log(`ğŸ“‚ Category Filter: ${this.selectedCategory.toUpperCase()}`);
  }
  if (this.topicLimit !== null) {
    console.log(`ğŸ” Topic limit applied: ${this.topicLimit}`);  // âœ… NEW
  }

  // ...

  // âœ… Pass targetTopics to batch generator
  let topics = await this.generateTopicsInBatches(approvedGaps, targetTopics);
}
```

### 4. Update Batch Generator to Accept Target

**`topic-generator.js:261-263`**
```javascript
/**
 * Generate topics in batches for reliability
 * Dynamically generates N topics based on topicLimit (defaults to 50)  // âœ… Updated doc
 */
async generateTopicsInBatches(approvedGaps, targetTotal = 50) {  // âœ… Accept parameter
  const batchSize = Math.min(25, targetTotal);  // âœ… Dynamic batch size
  const batches = Math.ceil(targetTotal / batchSize);

  console.log(`\nğŸ”„ Batch Generation Strategy: ${batches} batches of ${batchSize} topics each`);
  // ...
}
```

### 5. Update Orchestrator to Pass Limit

**`workflow-orchestrator.js:240`**
```javascript
async executeStage2Topics(options = {}) {  // âœ… Accept options
  console.log('\nğŸ“ STAGE 2: Topic Generation');
  console.log('-'.repeat(40));

  try {
    // ...

    // âœ… NEW: Get topic limit from options or config
    const limit = options.limit ?? this.config.topicLimit ?? null;

    // âœ… NEW: Create topic generator with limit if specified
    const topicGenerator = limit !== null
      ? new TopicGenerator({
          ...this.config,
          topicLimit: limit,
          seoDataFetcher: this.seoDataFetcher
        })
      : this.topicGenerator;

    if (limit !== null) {
      console.log(`ğŸ” Limiting topic generation to ${limit} topic(s)`);  // âœ… NEW
    }

    // Generate topics
    const topics = await topicGenerator.generateTopics();
    // ...
  }
}
```

### 6. Update executeStage() to Pass Options

**`workflow-orchestrator.js:661`**
```javascript
async executeStage(stageName, options = {}) {
  console.log(`\nğŸ¯ Executing Stage: ${stageName}`);

  switch (stageName.toLowerCase()) {
    case 'research':
      return await this.executeStage1Research();
    case 'topics':
      return await this.executeStage2Topics(options);  // âœ… Pass options
    case 'deep-research':
      return await this.executeStage3DeepResearch(options);
    case 'content':
      return await this.executeStage4ContentCreation(options);  // âœ… Pass options
    // ...
  }
}
```

## Testing

### Expected Behavior After Fix

```bash
$ node main.js stage topics --topic-limit=1

âœ… Topic Generator initialized
ğŸ¤– Primary Model: groq/compound (native web search)
ğŸ“Š Topic Limit: 1  # âœ… Limit shown

ğŸ¯ TOPIC GENERATION STARTED
==================================================
ğŸ¤– AI Model: groq/compound
ğŸ“Š Target: 1 strategic topics  # âœ… Dynamic target
ğŸ” Topic limit applied: 1      # âœ… Explicit confirmation

ğŸ“Š Found 140 approved research gaps
ğŸ¯ Generating strategic topics...
ğŸ” Limiting topic generation to 1 topic(s)  # âœ… Limit applied!

ğŸ”„ Batch Generation Strategy: 1 batches of 1 topics each  # âœ… Only 1 batch
ğŸ“¦ Generating Batch 1/1...  # âœ… Only 1 batch

âœ… Generated 1 topics from 140 research gaps  # âœ… Only 1 topic generated!
ğŸ“ 1 topics saved to: data/generated-topics.csv
```

### Test Cases

#### 1. Generate 1 Topic
```bash
node main.js stage topics --topic-limit=1
# Expected: 1 topic generated in 1 batch
```

#### 2. Generate 5 Topics
```bash
node main.js stage topics --topic-limit=5
# Expected: 5 topics generated in 1 batch (batchSize = min(25, 5) = 5)
```

#### 3. Generate 30 Topics
```bash
node main.js stage topics --topic-limit=30
# Expected: 30 topics in 2 batches (25 + 5)
```

#### 4. No Limit (Default)
```bash
node main.js stage topics
# Expected: 50 topics in 2 batches (25 + 25) - backward compatible
```

#### 5. With Category Filter
```bash
node main.js stage topics --topic-limit=1 --category=derivatives
# Expected: 1 topic from derivatives category only
```

## Batch Size Logic

The batch size dynamically adjusts based on the target:

```javascript
const batchSize = Math.min(25, targetTotal);
```

**Examples:**
- Target 1: `batchSize = min(25, 1) = 1` â†’ 1 batch of 1 topic
- Target 10: `batchSize = min(25, 10) = 10` â†’ 1 batch of 10 topics
- Target 30: `batchSize = min(25, 30) = 25` â†’ 2 batches (25 + 5)
- Target 50: `batchSize = min(25, 50) = 25` â†’ 2 batches (25 + 25)
- Target 100: `batchSize = min(25, 100) = 25` â†’ 4 batches (25 Ã— 4)

## Consistency Across Stages

Now **all content-generating stages** honor the `--topic-limit` parameter:

| Stage | Parameter | Default | Limit Source |
|-------|-----------|---------|--------------|
| **Stage 2** | `topicLimit` | 50 | `options.limit` â†’ `config.topicLimit` â†’ 50 |
| **Stage 3** | `deepResearchLimit` | null | `options.limit` â†’ `config.deepResearchLimit` â†’ null |
| **Stage 4** | `contentLimit` | null | `options.limit` â†’ `config.contentLimit` â†’ null |
| **Stage 6** | `publicationLimit` | null | `options.limit` â†’ `config.publicationLimit` â†’ null |

### Cascading Behavior

The `--topic-limit` parameter cascades through stages:

```bash
node main.js full --topic-limit=5 --auto-approve
```

**Flow:**
1. **Stage 2**: Generates exactly **5 topics** (not 50)
2. **Stage 3**: Researches exactly **5 topics** (inherits limit)
3. **Stage 4**: Creates content for **5 topics** (inherits limit)
4. **Stage 6**: Publishes **5 articles** (inherits limit)

## Usage Examples

### Command Line

```bash
# Generate only 1 topic
node main.js stage topics --topic-limit=1

# Generate 3 topics from specific category
node main.js stage topics --topic-limit=3 --category=derivatives

# Full workflow with topic limit
node main.js full --topic-limit=5 --auto-approve

# Override individual stage limits
node main.js full \
  --topic-limit=10 \      # Stage 2: 10 topics
  --deep-research-limit=5 \   # Stage 3: 5 researched
  --content-limit=3 \         # Stage 4: 3 drafted
  --publication-limit=2       # Stage 6: 2 published
```

### Programmatic Usage

```javascript
const orchestrator = new WorkflowOrchestrator({
  topicLimit: 5,
  autoApprove: true
});

// Stage 2 will generate 5 topics instead of 50
await orchestrator.executeStage('topics');

// Or pass limit at execution time
await orchestrator.executeStage('topics', { limit: 1 });
```

## Benefits

1. **Consistent API**: All stages now use the same `options.limit` pattern
2. **Testing Efficiency**: Test with `--topic-limit=1` for faster iteration
3. **Resource Control**: Generate fewer topics for limited API budgets
4. **Incremental Workflows**: Generate 5 topics, review, generate 5 more
5. **Backward Compatible**: Default behavior unchanged (50 topics)

## Related Files Modified

1. **`/backend/research/topic-generator.js`**
   - Added `topicLimit` property to constructor
   - Updated `generateTopics()` to use dynamic target
   - Updated `generateTopicsInBatches()` to accept target parameter
   - Added debug logging for topic limit

2. **`/backend/core/workflow-orchestrator.js`**
   - Updated `executeStage2Topics()` to accept `options` parameter
   - Added limit extraction and TopicGenerator recreation logic
   - Updated `executeStage()` to pass options to Stage 2
   - Added Stage 4 options passing (was missing before)

## Deployment

```bash
# Commit changes
git add backend/research/topic-generator.js
git add backend/core/workflow-orchestrator.js
git add STAGE2_TOPIC_LIMIT_IMPLEMENTATION.md

git commit -m "feat: Add dynamic topic limit support to Stage 2 (Topic Generation)

- Stage 2 now honors --topic-limit parameter instead of hardcoding 50 topics
- Consistent with Stage 3, 4, 6 limit behavior
- Batch size dynamically adjusts based on target (min(25, target))
- Added debug logging to show applied limits
- Backward compatible: defaults to 50 topics if no limit specified

Fixes topic generation ignoring --topic-limit parameter"

# Push to Railway (auto-deploy)
git push origin main
```

## Next Steps

After Railway deployment, verify with:

```bash
# Test Stage 2 with limit
node main.js stage topics --topic-limit=1 --auto-approve

# Test full workflow with limit
node main.js full --topic-limit=1 --auto-approve
```

Expected logs should show:
- âœ… `ğŸ“Š Topic Limit: 1`
- âœ… `ğŸ“Š Target: 1 strategic topics`
- âœ… `ğŸ” Topic limit applied: 1`
- âœ… `ğŸ” Limiting topic generation to 1 topic(s)`
- âœ… `ğŸ”„ Batch Generation Strategy: 1 batches of 1 topics each`
- âœ… `âœ… Generated 1 topics from 140 research gaps`

---

**Implemented by:** Claude Code
**Date:** 2025-01-09
**Issue:** Stage 2 ignored `--topic-limit` parameter
**Status:** âœ… Ready for deployment
